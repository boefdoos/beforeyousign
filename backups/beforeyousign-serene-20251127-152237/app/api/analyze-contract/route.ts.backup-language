import { NextRequest, NextResponse } from 'next/server'
import Anthropic from '@anthropic-ai/sdk'

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY || '',
})

export const runtime = 'nodejs'
export const dynamic = 'force-dynamic'

// Expert music industry knowledge based on Belgian/EU standards
// Sources: VI.BE, PlayRight, Cultuurloket, Amplo, Beroepkunstenaar.nl
const MUSIC_INDUSTRY_KNOWLEDGE = `
CRITICAL: Use Belgian/EU music industry standards for evaluation.
Sources: VI.BE, PlayRight, Cultuurloket, Amplo, industry practice Belgium/Benelux

=== BOOKING AGREEMENTS (Optreden / Live Performance) ===

COMMISSIE STRUCTURE - CRITICAL:
‚úì Standard commission: 10-15% 
‚úì IMPORTANT: Commission is paid ON TOP of artist fee by promoter/venue
‚úì Artist receives full agreed fee (e.g. ‚Ç¨1000)
‚úì Promoter pays: artist fee (‚Ç¨1000) + agency commission (‚Ç¨100-150)
‚úì Total cost for venue/promoter: ‚Ç¨1100-1150

‚úó RED FLAG: Commission deducted FROM artist fee (should come on top!)
‚úó RED FLAG: Commission > 20% (extremely high, only justified with extensive services)
‚úó RED FLAG: Hidden fees beyond standard commission

BE CAREFUL: Do NOT flag 10-15% as "high" - this is STANDARD practice!
Only flag as problematic if:
- Commission comes OFF the artist fee instead of ON TOP
- Commission > 20%
- Unclear who pays the commission

EXCLUSIVITY:
‚úì Reasonable: Specific region during event period (e.g. "No other shows within 50km for 2 weeks")
‚úì Reasonable: Genre-specific (e.g. "No other jazz festivals in Belgium that month")
‚úó RED FLAG: Blanket exclusivity without geographic/time limits
‚úó RED FLAG: Exclusivity > 6 months in same market

PAYMENT & SETTLEMENT:
‚úì Clear payment terms (e.g. 50% advance, 50% on performance night)
‚úì Payment within 30 days after performance
‚úó RED FLAG: No payment guarantees
‚úó RED FLAG: Payment only after "recoupment" of costs

CANCELLATION:
‚úì Must include force majeure clause (illness, natural disaster, etc.)
‚úì Reasonable cancellation fees (e.g. 50% if < 4 weeks notice)
‚úó RED FLAG: No cancellation clause or unreasonable penalties

TECHNICAL RIDER:
‚úì Artist can specify technical requirements (backline, sound, lights)
‚úì Reasonable requests for artist level
‚úó RED FLAG: Venue can change technical specs unilaterally


=== MANAGEMENT AGREEMENTS (Artist Manager) ===

Based on VI.BE, industry practice Belgium/NL

COMMISSIE:
‚úì Standard: 15-20% of GROSS income
‚úì Starting manager: 10-15% (proving their value)
‚úì Established manager with full services: 20% is normal
‚úó RED FLAG: > 25% without exceptional justification
‚úó RED FLAG: Commission on income where manager had no active role

IMPORTANT NUANCES:
- Beginning artists with new manager: 10-15% is fair
- Established relationship with proven results: 15-20% is normal
- Commission typically on gross, but can be negotiated on net after costs
- Be specific: commission on what? (Live, recording, publishing, merch, sync?)

DURATION:
‚úì Reasonable: 1-3 years with option to extend
‚úì Trial period: 6-12 months without long commitment
‚úó RED FLAG: > 5 years without exit clause
‚úó RED FLAG: Automatic renewal without opt-out period

EXIT CLAUSES:
‚úì Must be possible to exit with reasonable notice (1-3 months)
‚úì Underperformance clause (if targets not met, artist can exit)
‚úì Sunset clause: What happens AFTER contract ends? (commission on deals made during contract)
‚úó RED FLAG: No exit possibility during contract term
‚úó RED FLAG: Commission continues indefinitely after termination

SCOPE:
‚úì Clear definition: What does manager do? (bookings, promo, negotiations, etc.)
‚úì Key man clause: What if your contact person leaves the agency?
‚úó RED FLAG: Vague responsibilities
‚úó RED FLAG: Manager can sign contracts on artist's behalf without consent

COMMISSION ON PUBLISHING:
‚ö†Ô∏è SENSITIVE: Publishing rights are artist's most valuable asset
‚úì If manager actively works on publishing deals: 10-15% is acceptable
‚úó RED FLAG: Manager claims publishing % without active involvement
‚úó RED FLAG: > 20% of publishing income


=== LABEL DEALS (Recording Contracts) ===

Based on VI.BE artiestencontract documentation

ARTIST DEAL (Full Recording Contract):
‚úì Royalty rates: 
  - Indie label: 50/50 split POST-recoupment is fair
  - Better deal: 60/40 or 70/30 (artist/label)
  - Digital: Often higher rate (artist should get 60-70%)
‚úó RED FLAG: Artist gets < 50% post-recoupment
‚úó RED FLAG: No distinction between physical and digital rates

LICENSE DEAL:
‚úì Artist finances recording, label handles release
‚úì Label takes 70-75% of revenue (they pay pressing, distribution, promo)
‚úì Artist retains master ownership
‚úó RED FLAG: Label takes > 80%
‚úó RED FLAG: Label claims master ownership in license deal

JOINT VENTURE:
‚úì Equal investment, equal profit split (50/50)
‚úì Artist and label share costs and revenues equally
‚úó RED FLAG: Unequal split despite equal investment claims

DISTRIBUTION DEAL:
‚úì Commission: 15-30% depending on services
‚úì Artist retains: Masters, creative control, all other rights
‚úó RED FLAG: > 35% commission for pure distribution
‚úó RED FLAG: Distributor wants master ownership

ADVANCE:
‚úì Recoupable: Yes (label recoups from artist royalties)
‚úì Repayable: NO - Artist keeps advance even if record fails
‚úó RED FLAG: "Repayable" advance (must pay back from personal funds)
‚úó RED FLAG: Advance must be repaid before ANY royalties

RECOUPMENT:
‚úì Advance is recouped from artist's royalty share only
‚úì Clear accounting: Artist can verify expenses
‚úó RED FLAG: Cross-collateralization (Album 1 debt affects Album 2 earnings)
‚úó RED FLAG: Unclear what costs are recoupable

MASTER OWNERSHIP:
‚úì Reversion to artist after X years (typically 7-15 years)
‚úì Or: Artist retains ownership from start (license/distribution deals)
‚úó RED FLAG: Label keeps masters "in perpetuity" without reversion
‚úó RED FLAG: "Throughout the universe in perpetuity" clauses

DURATION & OPTIONS:
‚úì 1-2 albums + option, or max 3-4 years
‚úì Label has option, not obligation (protects artist if things don't work)
‚úó RED FLAG: > 5 years or > 3 albums without exit
‚úó RED FLAG: Automatic obligation for multiple albums

CREATIVE CONTROL:
‚úì Artist retains: Artistic direction, final say on releases, artwork
‚úì Artist approves: Single choices, marketing campaigns
‚úó RED FLAG: Label decides everything (artwork, tracklist, release timing)
‚úó RED FLAG: No approval rights for artist

RE-RECORDING RESTRICTION:
‚ö†Ô∏è COMMON: "You can't re-record these songs for X years with another label"
‚úì Reasonable: 2-5 years after contract ends
‚úó RED FLAG: > 7 years re-recording restriction
‚úó RED FLAG: Permanent restriction

360 DEALS:
Only acceptable if label ACTIVELY works on all revenue streams

‚úì OK if: Label provides active booking, tour support, merch production
‚úì Commission on side revenue: 10-20% IF they actively work on it
‚úó RED FLAG: Label takes % of live/merch WITHOUT providing services
‚úó RED FLAG: > 25% of side revenue
‚úó RED FLAG: Commission on non-music income (acting, endorsements)


=== PUBLISHING DEALS (Songwriting / Composition Rights) ===

BE CAREFUL: Publishing = songwriter rights, most valuable asset!

ADMINISTRATION DEAL (Best for artist):
‚úì Publisher manages rights for 10-20% commission
‚úì Artist retains 100% copyright ownership
‚úì This is the PREFERRED option for most artists

CO-PUBLISHING:
‚úì 50/50 split of publishing income
‚úì Copyright shared between artist and publisher
‚úì Reasonable IF publisher actively exploits catalog

FULL PUBLISHING DEAL:
‚úì ONLY acceptable with substantial advance (‚Ç¨25,000+)
‚úì Publisher gets 100% publisher's share
‚úó RED FLAG: Giving 100% publishing without major advance
‚úó RED FLAG: "Work for hire" (you don't own your songs)

DURATION:
‚úì Admin deal: 3-5 years
‚úì Co-publishing: 5-10 years with reversion
‚úó RED FLAG: Perpetuity without reversion
‚úó RED FLAG: > 15 years on co-pub or full pub without reversion


=== CONTRACT DURATION (General Principles) ===

‚úì Booking agreement: Per show or season (3-12 months)
‚úì Management: 1-3 years with exit clauses
‚úì Label: 1-2 albums + option, or 3-4 years maximum
‚úì Publishing admin: 3-5 years
‚úó RED FLAG: > 5 years on ANY deal without exit clause
‚úó RED FLAG: Automatic renewal without explicit opt-in


=== EXCLUSIVITY CLAUSES ===

‚úì Reasonable: Limited by genre, geography, duration
‚úì Example: "No other electronic music festivals in Belgium for 6 weeks"
‚úó RED FLAG: Worldwide exclusivity across all genres
‚úó RED FLAG: > 3 years broad exclusivity
‚úó RED FLAG: Cannot release music independently


=== ACCOUNTING & TRANSPARENCY ===

‚úì Quarterly or semi-annual royalty statements
‚úì Right to audit label's books (at artist's expense)
‚úì Clear breakdown of income and deductible costs
‚úó RED FLAG: Annual statements only or no statements
‚úó RED FLAG: No audit rights
‚úó RED FLAG: Vague cost definitions


=== KEY EVALUATION PRINCIPLES ===

1. CONTEXT MATTERS:
   - A 15% management commission is NORMAL, not "high"
   - A 10% booking commission is STANDARD, not something to negotiate down
   - 50/50 label split post-recoupment is FAIR for indie label
   
2. WHO PAYS WHAT:
   - Booking commission: Paid by VENUE/PROMOTER on top of artist fee
   - Management commission: Paid by ARTIST from their income
   - Label costs: Recoupable from artist royalties (but not repayable)

3. CAREER STAGE:
   - Beginning artist: Lower percentages reasonable while proving value
   - Established artist: Standard rates expected
   - Superstar: Can negotiate better terms

4. BELGIAN/EU SPECIFICS:
   - Handelsagentuurwet protects booking agents (1 month notice, compensation)
   - SABAM & PlayRight: Separate from label deals
   - Kunstenaarstatuut: Special tax/social status for artists

5. RED FLAGS vs NEGOTIATION POINTS:
   - RED FLAG: Deal breaker, walk away or heavily negotiate
   - MEDIUM: Point of attention, ask for clarification
   - LOW: Note it but may be acceptable with context

6. DON'T OVER-FLAG:
   - Only use "critical" for absolute dealbreakers
   - Many standard clauses are protective for both parties
   - Focus on genuinely problematic terms


=== SOURCES & VERIFICATION ===

All standards based on:
- VI.BE (Vlaams Instituut voor de Bewaarnemende en Uitvoerende Kunsten)
- Cultuurloket Belgi√´
- PlayRight (naburige rechten)
- Amplo
- Belgian/Benelux music industry practice
- Handelsagentuurwetgeving Belgi√´

Last updated: October 2025
`;

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData()
    const file = formData.get('contract') as File
    
    if (!file) {
      return NextResponse.json({ error: 'No file uploaded' }, { status: 400 })
    }

    console.log('üìÑ Processing file:', file.name, `(${(file.size / 1024).toFixed(2)} KB)`)

    const bytes = await file.arrayBuffer()
    const buffer = Buffer.from(bytes)
    const base64 = buffer.toString('base64')

    console.log('üöÄ Sending to Anthropic...')

    const message = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 4000,
      messages: [{
        role: 'user',
        content: [{
          type: 'document',
          source: {
            type: 'base64',
            media_type: 'application/pdf',
            data: base64,
          },
        }, {
          type: 'text',
          text: `${MUSIC_INDUSTRY_KNOWLEDGE}


CRITICAL: LOGIC CHECK BEFORE FLAGGING ANYTHING

Before marking something as a red flag, ask yourself:
1. WHO has the power/control according to the quote?
   - If quote says "Artist has exclusive rights to approve X" ‚Üí This PROTECTS the artist (POSITIVE)
   - If quote says "Promoter may decide X without artist consent" ‚Üí This HURTS the artist (NEGATIVE)

2. Does my conclusion MATCH the quote?
   - Quote: "Artist shall have exclusive rights to approve support acts"
   - CORRECT: "‚úì Positive: Artist retains approval rights over support acts"
   - WRONG: "‚úó Red flag: Promoter has control over support acts" ‚Üê This contradicts the quote!

3. Is this actually problematic?
   - Standard practice is NOT a problem
   - Artist having rights is GOOD, not bad
   - Only flag genuinely unfair terms

EXAMPLES OF COMMON MISTAKES TO AVOID:

CRITICAL: NEVER HALLUCINATE OR INVENT FACTS

‚ùå DO NOT mention specific company names as examples (e.g. "agencies like X or Y")
‚ùå DO NOT invent statistics or percentages unless they are in the contract
‚ùå DO NOT reference specific court cases or legal precedents
‚ùå DO NOT make up names of organizations, venues, or industry players

‚úì DO reference general industry standards ("Belgian booking agencies typically...")
‚úì DO cite official sources already mentioned in knowledge base (VI.BE, PlayRight, Cultuurloket)
‚úì DO use "established Belgian agencies" without naming specific companies
‚úì DO say "I cannot verify specific examples" if unsure

If you do not know something for certain, DO NOT make it up. Say "This should be verified with industry sources" instead.

‚ùå Quote says artist has rights ‚Üí Analysis says promoter has too much control
‚úì Quote says artist has rights ‚Üí Analysis says this protects the artist

‚ùå Quote says "reasonable notice required" ‚Üí Analysis flags as vague
‚úì Quote says "reasonable notice required" ‚Üí Analysis notes it is acceptable but could specify timeframe

CRITICAL TASK:
You are an experienced music industry lawyer with 15+ years representing artists in Belgium/EU.
Analyze this contract using BELGIAN/EU industry standards from VI.BE, Cultuurloket, PlayRight.

IMPORTANT PRINCIPLES:

1. CONTEXT IS EVERYTHING
   - 10-15% booking commission is STANDARD, NOT high
   - Booking commission comes ON TOP of artist fee (promoter pays)
   - 15-20% management commission is NORMAL
   - 50/50 label split post-recoupment is FAIR for indie

2. DON'T OVER-FLAG
   - Only flag genuinely problematic terms
   - Many "standard" clauses protect both parties
   - "Standard practice" doesn't mean "unfair"

3. BE SPECIFIC
   - Quote actual contract language
   - Explain WHY something is problematic
   - Compare to Belgian/EU industry standards
   - Consider artist's career stage

SEVERITY LEVELS (use carefully):
- "critical": Absolute dealbreaker (e.g. perpetual rights, repayable advance)
- "high": Serious problem, must negotiate (e.g. no exit clause, commission > 25%)
- "medium": Attention needed, clarify (e.g. vague terms, missing clauses)
- "low": Notable but often acceptable (e.g. standard restrictions)

WHAT TO CHECK:

BOOKING CONTRACTS:
‚úì Does commission come ON TOP or OFF artist fee? (On top = correct!)
‚úì Is 10-15% commission? (Standard, don't flag)
‚úì Payment terms clear?
‚úì Force majeure clause?

MANAGEMENT:
‚úì 15-20% commission? (Standard, don't flag)
‚úì Commission scope clear? (Live, recording, publishing?)
‚úì Exit clause present?
‚úì Duration reasonable (1-3 years)?

LABEL:
‚úì Who owns masters? Reversion clause?
‚úì Royalty split post-recoupment? (50/50 minimum)
‚úì Advance recoupable or repayable? (Repayable = bad!)
‚úì Cross-collateralization?
‚úì Creative control?

CRITICAL: Base your analysis on BELGIAN/EU standards, not US or UK standards!

Provide analysis in this EXACT JSON format (no markdown, no code blocks):

{
  "overallScore": [1-10, where 7-8 is "good standard contract"],
  "summary": "[2-3 sentences: contract type + overall fairness for Belgian/EU context]",
  "contractType": "[booking/management/label/distribution/publishing/360/band/other]",
  "careerStage": "[beginner/developing/established - based on contract terms]",
  "redFlags": [
    {
      "category": "[Commission/Duration/Rights/Payment/Control/etc.]",
      "severity": "[critical/high/medium/low]",
      "issue": "[What's the problem? Be specific.]",
      "explanation": "[WHY is this problematic? Compare to Belgian/EU standard. Consider context.]",
      "quote": "[Relevant contract text, if available]",
      "recommendation": "[What should artist do? Negotiate? Walk away? Get clarification?]"
    }
  ],
  "positivePoints": [
    "[Specific good aspects. WHY is this good? What's the standard it meets or exceeds?]"
  ],
  "recommendations": [
    "[Concrete, actionable recommendations based on Belgian/EU practice]"
  ],
  "marketComparison": "[How does this compare to Belgian/EU market standard? Reference general Belgian/EU industry standards without naming specific companies.]",
  "keyQuestions": [
    "[Important questions artist should ask before signing]"
  ]
}

REMEMBER:
- Don't flag standard Belgian/EU practices as problems
- Be nuanced: Consider career stage and context
- Focus on GENUINELY problematic terms
- Provide practical, actionable advice
- Use Belgian/EU standards, not US/UK

JSON only, no markdown, start with { and end with }.`
        }]
      }]
    })

    console.log('‚úÖ Response received')

    const responseText = message.content[0].type === 'text' ? message.content[0].text : ''
    let cleanedResponse = responseText.trim()
    
    // Remove markdown code blocks if present
    cleanedResponse = cleanedResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '')
    
    // Remove any leading/trailing whitespace
    cleanedResponse = cleanedResponse.trim()
    
    const analysis = JSON.parse(cleanedResponse)

    return NextResponse.json(analysis)
  } catch (error: any) {
    console.error('‚ùå ERROR:', error.type, error.status)
    
    if (error.status === 429 || error.type === 'rate_limit_error') {
      const errorMsg = error.error?.message || error.message || ''
      
      if (errorMsg.includes('acceleration') || errorMsg.includes('increase rate')) {
        return NextResponse.json(
          { 
            error: 'Rate limit: Too fast', 
            message: 'Je uploadde te snel meerdere documenten. Anthropic limiteert hoe snel nieuwe accounts kunnen opschalen.',
            details: '‚è∞ Wacht 5-10 minuten voor je het volgende document uploadt. Voor professioneel gebruik kun je hogere limieten aanvragen op console.anthropic.com/settings/limits'
          },
          { status: 429 }
        )
      }
      
      return NextResponse.json(
        { 
          error: 'Rate limit bereikt', 
          message: 'Te veel aanvragen. Even geduld aub.',
          details: 'Voor meer capaciteit kun je hogere limieten aanvragen op console.anthropic.com'
        },
        { status: 429 }
      )
    }

    return NextResponse.json(
      { 
        error: 'Analyse fout', 
        message: error.message || 'Onbekende fout',
        details: 'Probeer het opnieuw of neem contact op met support.'
      },
      { status: 500 }
    )
  }
}
